# StoryWorld Production Configuration
# Copy to .env and set values. Never commit .env.

# ---------------------------------------------------------------------------
# Environment
# ---------------------------------------------------------------------------
ENV=production
# ENV=local

# Reality Compiler Mode (product contract - default on)
# When true: neutral style, no cinematic specs, observer-driven retry
REALITY_COMPILER_MODE=true

# Run observer on each successful render; populate constraints_discovered
USE_OBSERVER_IN_PRODUCTION=true

# ---------------------------------------------------------------------------
# Database
# ---------------------------------------------------------------------------
DATABASE_URL=sqlite:///./local.db

# ---------------------------------------------------------------------------
# Redis (required for GPU job queue)
# ---------------------------------------------------------------------------
REDIS_URL=rediss://default:YOUR_PASSWORD@your-upstash-host:6379

# ---------------------------------------------------------------------------
# R2/S3 (required for observer to download videos; local server needs these)
# Worker generates presigned URLs for private buckets (no public GET needed).
# ---------------------------------------------------------------------------
# OPTION A (local): Set ARTIFACTS_DIR when worker+observer share a volume
# ARTIFACTS_DIR=/workspace/artifacts
# S3_ENDPOINT=https://xxx.r2.cloudflarestorage.com
# S3_BUCKET=storyworld-artifacts
# S3_ACCESS_KEY=your_r2_access_key
# S3_SECRET_KEY=your_r2_secret_key
# S3_REGION=auto

# ---------------------------------------------------------------------------
# Video Backends (GPU worker)
# ---------------------------------------------------------------------------
# Default backend for beats: veo (best quality), svd, animatediff, stub
# When Veo hits 429/credit exhausted, worker falls back to free open-source backend
DEFAULT_BACKEND=veo
# Fallback when Veo credit exhausted: svd (best free quality), animatediff, or stub
VEO_FALLBACK_BACKEND=svd
# Required for SVD/SDXL fallback without API: enables local SDXL keyframe generation
# USE_DIFFUSION=true

# ---------------------------------------------------------------------------
# Queue Names (MUST match RunPod worker for results to reach UI)
# No spaces around = (e.g. JOB_QUEUE=storyworld:gpu:jobs not JOB_QUEUE = ...)
# ---------------------------------------------------------------------------
# RESULT_QUEUE=storyworld:gpu:results
# JOB_QUEUE=storyworld:gpu:jobs
# GPU_JOB_QUEUE=storyworld:gpu:jobs
# GPU_RESULT_QUEUE=storyworld:gpu:results

# ---------------------------------------------------------------------------
# Planner
# ---------------------------------------------------------------------------
USE_MOCK_PLANNER=false
GEMINI_API_KEY=your_gemini_api_key
# GEMINI_OBSERVER_MODEL=gemini-2.0-flash-lite  # override (e.g. gemini-2.0-flash, gemini-2.5-flash)

# Intent classifier (LLM-based, no keyword tricks). Production: uses Gemini.
# INTENT_CLASSIFIER_MODEL=gemini-2.0-flash
# INTENT_CLASSIFIER_CACHE_SIZE=2000  # In-memory LRU cache size
# Intent classifier fallback: when Gemini 429, try Ollama (same chain as observer).
# INTENT_CLASSIFIER_FALLBACK_ENABLED=true  # Or inherits from OBSERVER_FALLBACK_ENABLED
# INTENT_CLASSIFIER_OLLAMA_MODEL=llama2    # Text model; defaults to OLLAMA_MODEL (avoid llava for text)
# INTENT_CLASSIFIER_OLLAMA_TIMEOUT=15

# Fallback open-source observer (Ollama) when Gemini returns 429 RESOURCE_EXHAUSTED
# Requires Ollama running locally with a vision model: ollama run llava
# If Ollama is not running, fallback returns mock (same as Gemini failure).
# OBSERVER_FALLBACK_ENABLED=true
# OLLAMA_BASE_URL=http://localhost:11434
# OLLAMA_MODEL=llava

# Observability re-render cap: after N re-renders for uncertain/insufficient_evidence,
# accept beat as best-effort to avoid infinite loop and PARTIALLY_COMPLETED
# OBSERVABILITY_MAX_ATTEMPTS=2

# ---------------------------------------------------------------------------
# Simulation Policies
# ---------------------------------------------------------------------------
# SIM_RETRY_MAX_ATTEMPTS=3
# SIM_QUALITY_MIN_CONFIDENCE=0.8
# SIM_COST_MAX_USD=10.0
# EP_RETRY_MAX_ATTEMPTS=2
# EP_QUALITY_MIN_CONFIDENCE=0.7
# EP_COST_MAX_USD=5.0

# ---------------------------------------------------------------------------
# Cost & Confidence
# ---------------------------------------------------------------------------
# COST_PER_BEAT_USD=0.05
# DEFAULT_SUCCESS_CONFIDENCE=0.85
# EPISODE_COMPOSE_REQUIRED_CONFIDENCE=0.3

# ---------------------------------------------------------------------------
# Logging
# ---------------------------------------------------------------------------
# DECISION_LOOP_LOG_PATH=decision_loop.log
